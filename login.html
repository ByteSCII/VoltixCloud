<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Voltix Cloud - Soporte al Cliente en tiempo real.">
    <meta name="keywords" content="Soporte, Atención al Cliente, Chat, Firebase, Discord, Voltix Cloud">
    <meta name="author" content="Voltix Cloud">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voltix Cloud - Soporte al Cliente</title>
    <!-- Favicon -->
    <link rel="icon" href="./images/logo.ico" type="image/x-icon">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter para texto general, Poppins para títulos, Bebas Neue para menú -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <!-- Font Awesome para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Configuración de Tailwind para colores y fuentes personalizadas */
        :root {
            --color-primary: #00CED1; /* Cian - Color primario para acentos */
            --color-secondary: #FFD700; /* Amarillo - Azul vibrante para acentos secundarios */
            --color-dark-bg: rgba(0, 0, 0, 0.95); /* Negro puro con ligera transparencia */
            --color-medium-dark-bg: rgba(10, 10, 10, 0.8); /* Negro oscuro fuerte con mayor transparencia */
            --color-card-bg: #2B2B2B; /* Fondo para tarjetas y elementos */
            --color-text-light: #F4F4F4; /* Texto blanco/gris claro */
            --color-text-dark: #212121; /* Texto oscuro para el botón cian */
            --color-text-muted: #A0A0A0; /* Texto gris atenuado */
            --color-border: #444444; /* Borde oscuro */
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: rgb(10, 10, 10); /* Fondo base negro oscuro fuerte */
            color: var(--color-text-light);
            position: relative;
            overflow-x: hidden;
            font-size: 0.95rem;
        }

        /* Custom Scrollbar Styles for Webkit browsers (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: 10px;
            border: 3px solid #333;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00A3A6;
        }

        /* Keyframes para la animación de destellos de rayo (MEJORADA Y VISIBLE) */
        @keyframes lightning-flash {
            0%, 100% {
                box-shadow: none;
                opacity: 0;
            }
            5% {
                box-shadow:
                    0 0 120px 60px rgba(255, 255, 255, 1),
                    0 0 240px 120px rgba(0, 206, 209, 0.9);
                opacity: 1;
            }
            6% {
                box-shadow: none;
                opacity: 0;
            }
            10% {
                box-shadow:
                    0 0 150px 75px rgba(255, 255, 255, 1),
                    0 0 300px 150px rgba(0, 206, 209, 1);
                opacity: 1;
            }
            11% {
                box-shadow: none;
                opacity: 0;
            }
            15% {
                box-shadow:
                    0 0 180px 90px rgba(255, 255, 255, 1),
                    0 0 360px 180px rgba(0, 206, 209, 1);
                opacity: 1;
            }
            16% {
                box-shadow: none;
                opacity: 0;
            }
            20% {
                box-shadow:
                    0 0 80px 40px rgba(0, 206, 209, 0.7);
                opacity: 0.6;
            }
            21% {
                box-shadow: none;
                opacity: 0;
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: -1;
            animation: lightning-flash 5s infinite steps(1);
            pointer-events: none;
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
        }
        h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
        }

        /* Estilos específicos para la página de soporte */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px); /* Ajustar según la altura del header */
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--color-medium-dark-bg);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            word-wrap: break-word;
        }

        .message-bubble.user {
            background-color: var(--color-primary);
            color: var(--color-text-dark);
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }

        .message-bubble.admin {
            background-color: var(--color-card-bg);
            color: var(--color-text-light);
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }

        .message-info {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 0.25rem;
        }

        .chat-input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            background-color: var(--color-dark-bg);
        }

        .chat-input-area input {
            flex-grow: 1;
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: var(--color-text-light);
            outline: none;
        }

        .chat-input-area button {
            margin-left: 1rem;
            background-color: var(--color-primary);
            color: var(--color-text-dark);
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }

        .chat-input-area button:hover {
            background-color: var(--color-secondary);
        }

        /* Admin Panel Specific Styles */
        .admin-panel {
            display: flex;
            height: calc(100vh - 80px); /* Ajustar según la altura del header */
            max-width: 1400px;
            margin: 0 auto;
            background-color: var(--color-medium-dark-bg);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .chat-list {
            width: 300px;
            border-right: 1px solid var(--color-border);
            overflow-y: auto;
            background-color: var(--color-dark-bg);
        }

        .chat-list-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .chat-list-item.active, .chat-list-item:hover {
            background-color: var(--color-card-bg);
        }

        .chat-list-item.unread {
            background-color: rgba(0, 206, 209, 0.1); /* Ligero cian para chats no leídos */
            border-left: 5px solid var(--color-primary);
        }

        .admin-chat-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .admin-chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--color-border);
            background-color: var(--color-dark-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-chat-header button {
            background-color: #dc2626; /* Rojo para cerrar */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .admin-chat-header button:hover {
            background-color: #b91c1c;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--color-medium-dark-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 0 25px rgba(0, 206, 209, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-muted);
            cursor: pointer;
        }

        .modal-close-button:hover {
            color: var(--color-primary);
        }

        .auth-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .auth-button.google {
            background-color: #DB4437; /* Google Red */
            color: white;
        }
        .auth-button.google:hover {
            background-color: #c23321;
            transform: translateY(-2px);
        }

        .auth-button.discord {
            background-color: #5865F2; /* Discord Purple */
            color: white;
        }
        .auth-button.discord:hover {
            background-color: #4752C4;
            transform: translateY(-2px);
        }

        .auth-button.email {
            background-color: var(--color-primary);
            color: var(--color-text-dark);
        }
        .auth-button.email:hover {
            background-color: #00A3A6;
            transform: translateY(-2px);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            color: var(--color-text-light);
            outline: none;
        }

        .form-button {
            background-color: var(--color-primary);
            color: var(--color-text-dark);
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .form-button:hover {
            background-color: var(--color-secondary);
        }

        .error-message {
            color: #ef4444; /* Tailwind red-500 */
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .chat-container, .admin-panel {
                height: calc(100vh - 60px); /* Ajustar para móviles */
                border-radius: 0;
            }
            .admin-panel {
                flex-direction: column;
            }
            .chat-list {
                width: 100%;
                height: 200px; /* Altura fija para la lista de chats en móvil */
                border-right: none;
                border-bottom: 1px solid var(--color-border);
            }
            .admin-chat-view {
                height: calc(100% - 200px); /* Resto del espacio para la vista de chat */
            }
            .message-bubble {
                max-width: 85%;
            }
        }

        /* Estilos para la interfaz de chat tipo teléfono */
        .phone-container {
            background-color: white;
            border-radius: 2rem;
            box-shadow: 0 0 30px rgba(0, 206, 209, 0.4);
            max-width: 400px; /* Tamaño típico de un teléfono */
            width: 95%;
            height: 700px; /* Altura típica de un teléfono */
            margin: 2rem auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 10; /* Asegurarse de que esté por encima del fondo */
        }

        .phone-header {
            background-color: var(--color-primary);
            color: var(--color-text-dark);
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            border-top-left-radius: 1.8rem;
            border-top-right-radius: 1.8rem;
        }

        .phone-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: #F0F2F5; /* Fondo claro por defecto */
            background-image: url('./images/fondoubicaciones.png'); /* IMAGEN DE FONDO APLICADA AQUÍ */
            background-size: cover; /* Cubrir todo el espacio */
            background-position: center; /* Centrar la imagen */
            background-repeat: no-repeat; /* No repetir la imagen */
            color: #333;
        }

        .phone-message-bubble {
            max-width: 80%;
            padding: 0.6rem 0.9rem;
            border-radius: 0.6rem;
            word-wrap: break-word;
            font-size: 0.9rem;
        }

        .phone-message-bubble.user {
            background-color: var(--color-primary);
            color: var(--color-text-dark);
            align-self: flex-end;
            border-bottom-right-radius: 0.2rem;
        }

        .phone-message-bubble.admin {
            background-color: #E0E0E0; /* Gris claro para mensajes del staff */
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 0.2rem;
        }

        .phone-message-info {
            font-size: 0.65rem;
            color: #666;
            margin-top: 0.15rem;
        }

        .phone-input-area {
            display: flex;
            padding: 0.8rem;
            border-top: 1px solid #E0E0E0;
            background-color: #FFFFFF;
        }

        .phone-input-area input {
            flex-grow: 1;
            background-color: #F0F2F5;
            border: 1px solid #D0D0D0;
            border-radius: 0.4rem;
            padding: 0.6rem 0.8rem;
            color: #333;
            outline: none;
            font-size: 0.9rem;
        }

        .phone-input-area button {
            margin-left: 0.75rem;
            background-color: var(--color-primary);
            color: var(--color-text-dark);
            font-weight: bold;
            padding: 0.6rem 1.2rem;
            border-radius: 0.4rem;
            transition: background-color 0.3s ease;
            font-size: 0.9rem;
        }

        .phone-input-area button:hover {
            background-color: var(--color-secondary);
        }

        /* Estilos para el modal de selección de soporte */
        .support-type-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .support-type-content {
            background-color: var(--color-medium-dark-bg);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 0 25px rgba(0, 206, 209, 0.5);
            max-width: 550px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .support-type-button {
            display: block;
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: var(--color-card-bg);
            border: 2px solid var(--color-border);
            border-radius: 0.75rem;
            color: var(--color-text-light);
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        }

        .support-type-button:hover {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-text-dark);
            transform: translateY(-3px);
        }

        .support-type-button:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .phone-container {
                width: 100%;
                height: calc(100vh - 120px); /* Ajustar para móviles */
                border-radius: 0;
                margin: 0;
            }
            .support-type-content {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header Section -->
    <header class="bg-medium-dark-bg text-text-light py-4 sticky top-0 z-50" style="background-color: var(--color-medium-dark-bg);">
        <div class="w-full px-4 flex justify-between items-center relative">
            <!-- Logo -->
            <a href="index.html" class="flex items-center">
                <img src="./images/logo.ico" alt="Logo" class="h-16 mr-2">
            </a>
            <h1 class="text-2xl md:text-3xl font-extrabold text-primary" style="color: var(--color-primary);">Soporte al Cliente</h1>
            <div id="auth-status" class="flex items-center space-x-4">
                <span id="user-display" class="font-semibold text-sm md:text-base hidden"></span>
                <button id="logout-button" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold text-sm md:text-base hidden hover:bg-red-700 transition-colors duration-300">
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </header>

    <main class="py-6 px-4">
        <!-- Contenedor principal para la aplicación de soporte -->
        <div id="app-container" class="hidden">
            <!-- Sección de Chat de Usuario (ahora dentro de un contenedor tipo teléfono) -->
            <section id="user-chat-section" class="phone-container hidden">
                <div class="phone-header">
                    Soporte Voltix Cloud <span id="current-support-type"></span>
                </div>
                <div id="chat-messages-display" class="phone-messages">
                    <!-- Los mensajes se cargarán aquí -->
                </div>
                <div class="phone-input-area">
                    <input type="text" id="user-message-input" placeholder="Escribe tu mensaje..." class="form-input">
                    <button id="send-user-message-button">Enviar</button>
                </div>
            </section>

            <!-- Sección de Panel de Administrador -->
            <section id="admin-panel-section" class="admin-panel hidden">
                <div class="chat-list">
                    <h2 class="text-xl font-semibold text-text-light p-4 border-b border-border bg-dark-bg">Chats Abiertos</h2>
                    <div id="admin-chat-list">
                        <!-- La lista de chats se cargará aquí -->
                    </div>
                    <!-- Sección de administración de administradores (solo visible para el CEO) -->
                    <div id="admin-management-section" class="p-4 border-t border-border bg-dark-bg mt-auto hidden">
                        <h3 class="text-lg font-semibold text-text-light mb-3">Administrar Administradores</h3>
                        <input type="email" id="new-admin-email-input" placeholder="Email del nuevo admin" class="form-input">
                        <button id="add-admin-button" class="form-button">Añadir Administrador</button>
                        <p id="admin-management-message" class="text-xs text-text-muted mt-2"></p>
                    </div>
                </div>
                <div class="admin-chat-view flex-grow">
                    <div id="admin-chat-header" class="admin-chat-header hidden">
                        <h3 class="text-xl font-semibold text-text-light" id="current-chat-user-name"></h3>
                        <span class="text-sm text-text-muted ml-2">(Tipo: <span id="admin-chat-support-type"></span>)</span>
                        <button id="close-chat-button">Cerrar Chat</button>
                    </div>
                    <div id="admin-chat-messages-display" class="chat-messages">
                        <!-- Los mensajes del chat seleccionado se cargarán aquí -->
                        <p id="no-chat-selected-message" class="text-center text-text-muted mt-20">Selecciona un chat de la lista.</p>
                    </div>
                    <div id="admin-chat-input-area" class="chat-input-area hidden">
                        <input type="text" id="admin-message-input" placeholder="Responde al usuario..." class="form-input">
                        <button id="send-admin-message-button">Enviar</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Modal de Autenticación -->
        <div id="auth-modal" class="modal">
            <div class="modal-content">
                <button class="modal-close-button" id="close-auth-modal">&times;</button>
                <h2 class="text-2xl font-bold text-text-light mb-6">Iniciar Sesión / Registrarse</h2>

                <div id="auth-forms">
                    <div id="login-form">
                        <input type="email" id="email-login" placeholder="Correo Electrónico" class="form-input">
                        <input type="password" id="password-login" placeholder="Contraseña" class="form-input">
                        <button id="login-button" class="form-button mb-4">Iniciar Sesión</button>
                        <p class="text-text-muted mb-4">¿No tienes cuenta? <a href="#" id="show-register" class="text-primary hover:underline">Regístrate aquí</a></p>
                    </div>
                    <div id="register-form" class="hidden">
                        <input type="email" id="email-register" placeholder="Correo Electrónico" class="form-input">
                        <input type="password" id="password-register" placeholder="Contraseña" class="form-input">
                        <button id="register-button" class="form-button mb-4">Registrarse</button>
                        <p class="text-text-muted mb-4">¿Ya tienes cuenta? <a href="#" id="show-login" class="text-primary hover:underline">Inicia Sesión</a></p>
                    </div>
                    <div class="my-4 text-text-muted">O inicia sesión con:</div>
                    <button id="google-auth-button" class="auth-button google">
                        <i class="fab fa-google text-lg"></i> Iniciar Sesión con Google
                    </button>
                    <button id="discord-auth-button" class="auth-button discord">
                        <i class="fab fa-discord text-lg"></i> Iniciar Sesión con Discord
                    </button>
                </div>

                <div id="email-verification-message" class="hidden text-center">
                    <p class="text-lg text-text-light mb-4">¡Tu cuenta necesita verificación!</p>
                    <p class="text-text-muted mb-6">Hemos enviado un enlace de verificación a tu correo electrónico. Por favor, revisa tu bandeja de entrada (y la carpeta de spam).</p>
                    <button id="resend-verification-email" class="form-button">Reenviar Correo de Verificación</button>
                </div>

                <p id="auth-error-message" class="error-message hidden"></p>
            </div>
        </div>

        <!-- Modal de Selección de Tipo de Soporte -->
        <div id="support-type-selection-modal" class="support-type-modal hidden">
            <div class="support-type-content">
                <h2 class="text-2xl font-bold text-text-light mb-6">¿Qué tipo de soporte necesitas?</h2>
                <button class="support-type-button" data-type="Minecraft Hosting">Minecraft Hosting</button>
                <button class="support-type-button" data-type="Web Hosting">Web Hosting</button>
                <button class="support-type-button" data-type="Web Design">Web Design</button>
                <p id="support-type-error-message" class="error-message hidden mt-4"></p>
            </div>
        </div>
    </main>

    <!-- Footer Section (Opcional, si quieres mantener el footer de la página principal) -->
    <footer class="text-text-muted py-6 text-center">
        <div class="container mx-auto px-4 text-xs">
            &copy; 2025 Voltix Cloud. Todos los derechos reservados.
        </div>
    </footer>

    <script type="module">
        // Importar las funciones necesarias de Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            OAuthProvider, // Para Discord
            EmailAuthProvider,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            sendEmailVerification // Importar sendEmailVerification
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            orderBy,
            onSnapshot,
            doc,
            updateDoc,
            where,
            serverTimestamp,
            limit,
            getDocs, // Importar getDocs para consultas puntuales
            setDoc, // Importar setDoc para añadir documentos con ID específico
            getDoc // Importar getDoc para obtener un documento por ID
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase (proporcionada por el usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyAwJIrbfj9rWiTe0bytrSX644deGhYu6Ek",
            authDomain: "voltix-cloud.firebaseapp.com",
            projectId: "voltix-cloud",
            storageBucket: "voltix-cloud.firebaseapis.com",
            messagingSenderId: "693466536281",
            appId: "1:693466536281:web:77be9d4e23f59c02799448"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Variables Globales y Referencias DOM ---
        const authModal = document.getElementById('auth-modal');
        const closeAuthModalButton = document.getElementById('close-auth-modal');
        const authForms = document.getElementById('auth-forms'); // Nuevo contenedor para los formularios
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const emailLoginInput = document.getElementById('email-login');
        const passwordLoginInput = document.getElementById('password-login');
        const loginButton = document.getElementById('login-button');
        const emailRegisterInput = document.getElementById('email-register');
        const passwordRegisterInput = document.getElementById('password-register');
        const registerButton = document.getElementById('register-button');
        const googleAuthButton = document.getElementById('google-auth-button');
        const discordAuthButton = document.getElementById('discord-auth-button');
        const authErrorMessage = document.getElementById('auth-error-message');
        const userDisplay = document.getElementById('user-display');
        const logoutButton = document.getElementById('logout-button');
        const appContainer = document.getElementById('app-container');

        // Nuevos elementos para verificación de email
        const emailVerificationMessage = document.getElementById('email-verification-message');
        const resendVerificationEmailButton = document.getElementById('resend-verification-email');


        // Secciones de la aplicación
        const userChatSection = document.getElementById('user-chat-section'); // Ahora es el contenedor del teléfono
        const adminPanelSection = document.getElementById('admin-panel-section');

        // Elementos del chat de usuario (dentro del teléfono)
        const chatMessagesDisplay = document.getElementById('chat-messages-display'); // Ahora phone-messages
        const userMessageInput = document.getElementById('user-message-input'); // Ahora phone-input-area input
        const sendUserMessageButton = document.getElementById('send-user-message-button'); // Ahora phone-input-area button
        const currentSupportTypeDisplay = document.getElementById('current-support-type'); // Para mostrar el tipo de soporte en el header del teléfono

        // Elementos del panel de administrador
        const adminChatList = document.getElementById('admin-chat-list');
        const adminChatHeader = document.getElementById('admin-chat-header'); // CORRECCIÓN: Eliminado 'document ='
        const currentChatUserName = document.getElementById('current-chat-user-name');
        const adminChatSupportTypeDisplay = document.getElementById('admin-chat-support-type'); // Para mostrar el tipo de soporte en el admin
        const closeChatButton = document.getElementById('close-chat-button');
        const adminChatMessagesDisplay = document.getElementById('admin-chat-messages-display');
        const adminMessageInput = document.getElementById('admin-message-input');
        const sendAdminMessageButton = document.getElementById('send-admin-message-button');
        const noChatSelectedMessage = document.getElementById('no-chat-selected-message');
        const adminChatInputArea = document.getElementById('admin-chat-input-area');

        // Elementos para la administración de administradores
        const adminManagementSection = document.getElementById('admin-management-section'); // Nueva referencia
        const newAdminEmailInput = document.getElementById('new-admin-email-input');
        const addAdminButton = document.getElementById('add-admin-button');
        const adminManagementMessage = document.getElementById('admin-management-message');

        // Elementos del modal de selección de soporte
        const supportTypeSelectionModal = document.getElementById('support-type-selection-modal');
        const supportTypeButtons = document.querySelectorAll('.support-type-button');
        const supportTypeError = document.getElementById('support-type-error-message');


        let currentUser = null;
        let isAdmin = false;
        let isCEO = false; // Nuevo flag para el CEO
        let currentChatId = null; // ID del chat actualmente seleccionado por el usuario o admin
        let unsubscribeMessages = null; // Para desuscribirse de los listeners de mensajes

        // --- UID del CEO (¡REEMPLAZA ESTO CON TU UID REAL!) ---
        // Para encontrar tu UID: Inicia sesión con ceovoltixcloud@gmail.com,
        // ve a la Consola de Firebase -> Authentication -> Users, y copia tu UID.
        const CEO_UID = 'w5mLP8fsHUaOSSEMilsx6LXLmUF3'; // <--- ¡IMPORTANTE! REEMPLAZA ESTO

        // --- Webhook de Discord ---
        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1391529116833939497/_V1rq1oipxDSWkYR9U_HWIPb4oKZhHZ8objZwmcLfPWZvfTFnRb-thUgan65ilB1DxIEok";

        // --- Funciones de Utilidad ---

        /**
         * Muestra mensajes de error en el modal de autenticación.
         * @param {string} message - El mensaje de error a mostrar.
         */
        function showAuthError(message) {
            authErrorMessage.textContent = message;
            authErrorMessage.classList.remove('hidden');
        }

        /**
         * Oculta los mensajes de error del modal de autenticación.
         */
        function hideAuthError() {
            authErrorMessage.classList.add('hidden');
            authErrorMessage.textContent = '';
        }

        /**
         * Muestra el mensaje de verificación de correo electrónico.
         */
        function showEmailVerificationMessage() {
            authForms.classList.add('hidden');
            emailVerificationMessage.classList.remove('hidden');
            hideAuthError(); // Ocultar otros errores cuando se muestra este mensaje
        }

        /**
         * Oculta el mensaje de verificación de correo electrónico.
         */
        function hideEmailVerificationMessage() {
            authForms.classList.remove('hidden');
            emailVerificationMessage.classList.add('hidden');
        }

        /**
         * Muestra un mensaje en el modal de selección de soporte.
         * @param {string} message - El mensaje a mostrar.
         * @param {string} type - 'success' o 'error'.
         */
        function showSupportTypeError(message, type = 'error') {
            supportTypeError.textContent = message;
            supportTypeError.classList.remove('hidden');
            supportTypeError.style.color = (type === 'error' ? '#ef4444' : '#34d399');
        }

        /**
         * Oculta el mensaje del modal de selección de soporte.
         */
        function hideSupportTypeError() {
            supportTypeError.classList.add('hidden');
            supportTypeError.textContent = '';
        }

        /**
         * Formatea un timestamp de Firebase a una cadena legible.
         * @param {object} timestamp - El objeto Timestamp de Firebase.
         * @returns {string} La fecha y hora formateada.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return date.toLocaleString('es-ES', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /**
         * Envía un mensaje a un webhook de Discord.
         * @param {string} username - Nombre de usuario para el webhook.
         * @param {string} message - Contenido del mensaje.
         * @param {string} chatLink - Enlace al chat en el panel de administración (opcional).
         */
        async function sendDiscordWebhookMessage(username, message, chatLink = '') {
            const payload = {
                username: "Voltix Cloud Soporte",
                avatar_url: "https://voltixcloud.web.app/images/logo.ico", // Usar el logo de Voltix Cloud
                embeds: [{
                    title: `Nuevo mensaje de ${username}`,
                    description: message,
                    color: 3447003, // Un color cian para que coincida con el tema
                    fields: []
                }]
            };

            if (chatLink) {
                payload.embeds[0].fields.push({
                    name: "Acceder al Chat",
                    value: `[Haz clic aquí para responder](${chatLink})`,
                    inline: false
                });
            }

            try {
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    console.error('Error al enviar mensaje a Discord:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error de red al enviar mensaje a Discord:', error);
            }
        }

        /**
         * Guarda el perfil del usuario en la colección 'user_profiles'.
         * @param {object} user - El objeto User de Firebase.
         */
        async function saveUserProfile(user) {
            try {
                await setDoc(doc(db, `user_profiles`, user.uid), {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email || 'Usuario Nuevo',
                    lastLogin: serverTimestamp()
                }, { merge: true }); // Usar merge: true para no sobrescribir si ya existe
                console.log("Perfil de usuario guardado/actualizado:", user.uid);
            } catch (e) {
                console.error("Error al guardar perfil de usuario:", e);
            }
        }

        // --- Lógica de Autenticación ---

        /**
         * Maneja el inicio de sesión con correo electrónico y contraseña.
         */
        async function handleEmailLogin() {
            hideAuthError();
            const email = emailLoginInput.value;
            const password = passwordLoginInput.value;
            if (!email || !password) {
                showAuthError('Por favor, ingresa correo y contraseña.');
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged manejará la lógica de verificación de email y redirección
            } catch (error) {
                console.error("Error al iniciar sesión con email:", error);
                showAuthError('Error al iniciar sesión: ' + error.message);
            }
        }

        /**
         * Maneja el registro con correo electrónico y contraseña.
         */
        async function handleEmailRegister() {
            hideAuthError();
            const email = emailRegisterInput.value;
            const password = passwordRegisterInput.value;
            if (!email || !password) {
                showAuthError('Por favor, ingresa correo y contraseña.');
                return;
            }
            if (password.length < 6) {
                showAuthError('La contraseña debe tener al menos 6 caracteres.', 'error');
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await sendEmailVerification(userCredential.user);
                await saveUserProfile(userCredential.user); // Guardar perfil del usuario
                showAuthError('¡Registro exitoso! Por favor, verifica tu correo electrónico.');
                // Cambiar a la vista de mensaje de verificación
                showEmailVerificationMessage();
            } catch (error) {
                console.error("Error al registrarse con email:", error);
                showAuthError('Error al registrarse: ' + error.message);
            }
        }

        /**
         * Maneja el inicio de sesión con Google.
         */
        async function handleGoogleAuth() {
            hideAuthError();
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                await saveUserProfile(result.user); // Guardar perfil del usuario
                // onAuthStateChanged manejará la lógica de redirección
            } catch (error) {
                console.error("Error al iniciar sesión con Google:", error);
                showAuthError('Error al iniciar sesión con Google: ' + error.message);
            }
        }

        /**
         * Maneja el inicio de sesión con Discord.
         */
        async function handleDiscordAuth() {
            hideAuthError();
            const provider = new OAuthProvider('discord.com');
            try {
                const result = await signInWithPopup(auth, provider);
                await saveUserProfile(result.user); // Guardar perfil del usuario
                // onAuthStateChanged manejará la lógica de redirección
            } catch (error) {
                console.error("Error al iniciar sesión con Discord:", error);
                showAuthError('Error al iniciar sesión con Discord: ' + error.message);
            }
        }

        /**
         * Maneja el cierre de sesión.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
            }
        }

        // --- Lógica de Chat ---

        /**
         * Crea un nuevo chat para el usuario actual con el tipo de soporte seleccionado.
         * @param {string} supportType - El tipo de soporte seleccionado (ej. "Minecraft Hosting").
         */
        async function createNewChat(supportType) {
            if (!currentUser) {
                showCustomModal('Debes iniciar sesión para iniciar un chat.', 'alert');
                return;
            }

            // Opcional: Comprobar si ya existe un chat abierto para este usuario
            const existingChatsQuery = query(
                collection(db, `artifacts/${__app_id}/public/data/chats`),
                where('userId', '==', currentUser.uid),
                where('status', '==', 'open'),
                limit(1)
            );

            const existingChatsSnapshot = await getDocs(existingChatsQuery);

            if (!existingChatsSnapshot.empty) {
                // Si ya hay un chat abierto, simplemente lo seleccionamos
                currentChatId = existingChatsSnapshot.docs[0].id;
                const chatData = existingChatsSnapshot.docs[0].data();
                currentSupportTypeDisplay.textContent = chatData.supportType || '';
                console.log("Ya existe un chat abierto, continuando con:", currentChatId);
                loadUserChatMessages(currentChatId);
                supportTypeSelectionModal.classList.add('hidden'); // Ocultar modal si ya hay chat
                userChatSection.classList.remove('hidden'); // Mostrar la sección de chat
                return;
            }

            try {
                const docRef = await addDoc(collection(db, `artifacts/${__app_id}/public/data/chats`), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email || 'Usuario Anónimo',
                    status: 'open', // 'open', 'closed', 'pending'
                    supportType: supportType, // Guardar el tipo de soporte
                    createdAt: serverTimestamp(),
                    lastMessageAt: serverTimestamp(),
                    adminId: null // Se asignará cuando un admin tome el chat
                });
                currentChatId = docRef.id;
                currentSupportTypeDisplay.textContent = supportType; // Actualizar el display
                console.log("Nuevo chat creado con ID:", currentChatId);
                loadUserChatMessages(currentChatId);
                supportTypeSelectionModal.classList.add('hidden'); // Ocultar modal
                userChatSection.classList.remove('hidden'); // Mostrar la sección de chat
            } catch (error) {
                console.error("Error al crear nuevo chat:", error);
                showCustomModal('Error al iniciar un nuevo chat. Inténtalo de nuevo.', 'alert');
                supportTypeSelectionModal.classList.remove('hidden'); // Si falla, mantener el modal visible
            }
        }

        /**
         * Envía un mensaje al chat actual.
         * @param {string} messageText - El texto del mensaje.
         * @param {string} senderRole - 'user' o 'admin'.
         */
        async function sendMessage(messageText, senderRole) {
            if (!currentChatId || !currentUser || !messageText.trim()) return;

            try {
                await addDoc(collection(db, `artifacts/${__app_id}/public/data/chats/${currentChatId}/messages`), {
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email || 'Usuario Anónimo',
                    text: messageText.trim(),
                    timestamp: serverTimestamp(),
                    senderRole: senderRole,
                    isReadByAdmin: senderRole === 'user' ? false : true, // Marcar como no leído por admin si es de usuario
                    isReadByUser: senderRole === 'admin' ? false : true // Marcar como no leído por usuario si es de admin
                });

                // Actualizar el timestamp del último mensaje en el documento del chat
                await updateDoc(doc(db, `artifacts/${__app_id}/public/data/chats`, currentChatId), {
                    lastMessageAt: serverTimestamp()
                });

                // Si el mensaje es del usuario, enviar a Discord
                if (senderRole === 'user') {
                    // Asegúrate de que esta URL sea la URL real de tu página de soporte con el panel de administración
                    const chatLink = `https://voltixcloud.web.app/support.html?chatId=${currentChatId}`;
                    sendDiscordWebhookMessage(
                        currentUser.displayName || currentUser.email || 'Usuario Anónimo',
                        messageText.trim(),
                        chatLink
                    );
                }

            } catch (error) {
                console.error("Error al enviar mensaje:", error);
                // Mostrar un mensaje al usuario si falla el envío
            }
        }

        /**
         * Carga y muestra los mensajes del chat para el usuario.
         * @param {string} chatId - ID del chat a cargar.
         */
        function loadUserChatMessages(chatId) {
            if (unsubscribeMessages) {
                unsubscribeMessages(); // Desuscribirse del chat anterior
            }
            chatMessagesDisplay.innerHTML = ''; // Limpiar mensajes anteriores
            userMessageInput.value = ''; // Limpiar input

            const messagesQuery = query(
                collection(db, `artifacts/${__app_id}/public/data/chats/${chatId}/messages`),
                orderBy('timestamp', 'asc')
            );

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                chatMessagesDisplay.innerHTML = ''; // Limpiar para recrear
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const isCurrentUser = message.senderId === currentUser.uid;
                    const bubbleClass = isCurrentUser ? 'user' : 'admin'; // Si no es el usuario, es admin
                    const senderName = isCurrentUser ? 'Tú' : message.senderName;

                    const messageElement = document.createElement('div');
                    messageElement.classList.add('phone-message-bubble', bubbleClass); // Usar clases de teléfono
                    messageElement.innerHTML = `
                        <p>${message.text}</p>
                        <div class="phone-message-info">${senderName} - ${formatTimestamp(message.timestamp)}</div>
                    `;
                    chatMessagesDisplay.appendChild(messageElement);
                });
                // Desplazarse al último mensaje
                chatMessagesDisplay.scrollTop = chatMessagesDisplay.scrollHeight;

                // Marcar los mensajes del admin como leídos por el usuario
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const message = change.doc.data();
                        if (message.senderRole === 'admin' && message.isReadByUser === false) {
                            updateDoc(doc(db, `artifacts/${__app_id}/public/data/chats/${chatId}/messages`, change.doc.id), {
                                isReadByUser: true
                            }).catch(e => console.error("Error al marcar mensaje como leído:", e));
                        }
                    }
                });
            }, (error) => {
                console.error("Error al cargar mensajes del chat de usuario:", error);
                chatMessagesDisplay.innerHTML = `<p class="text-red-500 text-center">Error al cargar mensajes.</p>`;
            });
        }

        // --- Lógica del Panel de Administrador ---

        /**
         * Carga y muestra la lista de chats para el administrador.
         * La ordenación se realiza en JavaScript para evitar la necesidad de un índice compuesto.
         */
        function loadAdminChatList() {
            const q = query(
                collection(db, `artifacts/${__app_id}/public/data/chats`),
                where('status', '==', 'open')
                // Se eliminó orderBy('lastMessageAt', 'desc') para evitar el error de índice.
                // La ordenación se realizará en el cliente.
            );

            onSnapshot(q, (snapshot) => {
                let chats = [];
                snapshot.forEach(docChat => {
                    chats.push({ id: docChat.id, ...docChat.data() });
                });

                // Ordenar los chats por lastMessageAt en el cliente
                chats.sort((a, b) => {
                    const timeA = a.lastMessageAt ? a.lastMessageAt.toMillis() : 0;
                    const timeB = b.lastMessageAt ? b.lastMessageAt.toMillis() : 0;
                    return timeB - timeA; // Orden descendente
                });

                adminChatList.innerHTML = ''; // Limpiar lista
                chats.forEach(chat => {
                    const chatId = chat.id;

                    // Escuchar mensajes para este chat para detectar no leídos
                    const messagesQuery = query(
                        collection(db, `artifacts/${__app_id}/public/data/chats/${chatId}/messages`),
                        where('senderRole', '==', 'user'),
                        where('isReadByAdmin', '==', false)
                    );

                    onSnapshot(messagesQuery, (messagesSnapshot) => {
                        const hasUnread = !messagesSnapshot.empty;
                        let chatListItem = document.getElementById(`chat-item-${chatId}`);
                        if (!chatListItem) {
                            chatListItem = document.createElement('div');
                            chatListItem.id = `chat-item-${chatId}`;
                            chatListItem.classList.add('chat-list-item', 'p-4', 'cursor-pointer', 'hover:bg-gray-800', 'border-b', 'border-gray-700');
                            chatListItem.innerHTML = `
                                <div class="font-semibold text-text-light">${chat.userName}</div>
                                <div class="text-sm text-text-muted">ID: ${chatId.substring(0, 8)}...</div>
                                <div class="text-xs text-text-muted">Tipo: ${chat.supportType || 'N/A'}</div>
                                <div class="text-xs text-text-muted">${formatTimestamp(chat.lastMessageAt)}</div>
                                <div class="text-xs text-red-400" id="unread-indicator-${chatId}"></div>
                            `;
                            adminChatList.appendChild(chatListItem); // Añadir al DOM
                        }

                        // Actualizar indicador de no leído
                        const unreadIndicator = document.getElementById(`unread-indicator-${chatId}`);
                        if (hasUnread) {
                            unreadIndicator.textContent = '¡Mensajes no leídos!';
                            chatListItem.classList.add('unread');
                        } else {
                            unreadIndicator.textContent = '';
                            chatListItem.classList.remove('unread');
                        }

                        chatListItem.onclick = () => selectAdminChat(chatId, chat.userName, chat.supportType);
                        if (chatId === currentChatId) {
                            chatListItem.classList.add('active');
                        } else {
                            chatListItem.classList.remove('active');
                        }
                    });
                });
            }, (error) => {
                console.error("Error al cargar lista de chats de admin:", error);
            });
        }

        /**
         * Selecciona un chat en el panel de administrador y carga sus mensajes.
         * @param {string} chatId - ID del chat a seleccionar.
         * @param {string} userName - Nombre del usuario del chat.
         * @param {string} supportType - Tipo de soporte del chat.
         */
        async function selectAdminChat(chatId, userName, supportType) {
            if (unsubscribeMessages) {
                unsubscribeMessages(); // Desuscribirse del chat anterior
            }

            currentChatId = chatId;
            currentChatUserName.textContent = `Chat con ${userName}`;
            adminChatSupportTypeDisplay.textContent = supportType || 'N/A';
            adminChatHeader.classList.remove('hidden');
            adminChatInputArea.classList.remove('hidden');
            noChatSelectedMessage.classList.add('hidden');
            adminChatMessagesDisplay.innerHTML = ''; // Limpiar mensajes anteriores
            adminMessageInput.value = ''; // Limpiar input

            // Actualizar clase 'active' en la lista de chats
            document.querySelectorAll('.chat-list-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`chat-item-${chatId}`).classList.add('active');

            const messagesQuery = query(
                collection(db, `artifacts/${__app_id}/public/data/chats/${chatId}/messages`),
                orderBy('timestamp', 'asc')
            );

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                adminChatMessagesDisplay.innerHTML = ''; // Limpiar para recrear
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const isCurrentUserAdmin = message.senderId === currentUser.uid;
                    const bubbleClass = isCurrentUserAdmin ? 'admin' : 'user';
                    const senderName = isCurrentUserAdmin ? 'Tú (Admin)' : message.senderName;

                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message-bubble', bubbleClass);
                    messageElement.innerHTML = `
                        <p>${message.text}</p>
                        <div class="message-info">${senderName} - ${formatTimestamp(message.timestamp)}</div>
                    `;
                    adminChatMessagesDisplay.appendChild(messageElement);
                });
                // Desplazarse al último mensaje
                adminChatMessagesDisplay.scrollTop = adminChatMessagesDisplay.scrollHeight;

                // Marcar los mensajes del usuario como leídos por el admin
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const message = change.doc.data();
                        if (message.senderRole === 'user' && message.isReadByAdmin === false) {
                            updateDoc(doc(db, `artifacts/${__app_id}/public/data/chats/${chatId}/messages`, change.doc.id), {
                                isReadByAdmin: true
                            }).catch(e => console.error("Error al marcar mensaje como leído:", e));
                        }
                    }
                }
            );
            }, (error) => {
                console.error("Error al cargar mensajes del chat de admin:", error);
                adminChatMessagesDisplay.innerHTML = `<p class="text-red-500 text-center">Error al cargar mensajes.</p>`;
            });
        }

        /**
         * Cierra el chat actualmente seleccionado por el administrador.
         */
        async function closeSelectedChat() {
            if (!currentChatId) return;

            const confirmed = await window.confirm('¿Estás seguro de que quieres cerrar este chat?');
            if (confirmed) {
                try {
                    await updateDoc(doc(db, `artifacts/${__app_id}/public/data/chats`, currentChatId), {
                        status: 'closed'
                    });
                    console.log("Chat cerrado:", currentChatId);
                    // Limpiar la vista del chat
                    currentChatId = null;
                    if (unsubscribeMessages) {
                        unsubscribeMessages();
                        unsubscribeMessages = null;
                    }
                    adminChatHeader.classList.add('hidden');
                    adminChatInputArea.classList.add('hidden');
                    adminChatMessagesDisplay.innerHTML = '';
                    noChatSelectedMessage.classList.remove('hidden');
                } catch (error) {
                    console.error("Error al cerrar chat:", error);
                    window.alert('Error al cerrar el chat. Inténtalo de nuevo.');
                }
            }
        }

        /**
         * Añade un nuevo administrador a la colección 'admin_users'.
         * Solo el CEO puede realizar esta acción.
         */
        async function addAdmin() {
            if (!currentUser || !isCEO) {
                adminManagementMessage.textContent = "Error: Solo el CEO puede añadir administradores.";
                adminManagementMessage.style.color = '#ef4444';
                return;
            }

            const emailToAdd = newAdminEmailInput.value.trim();
            if (!emailToAdd) {
                adminManagementMessage.textContent = "Por favor, introduce el correo electrónico del nuevo administrador.";
                adminManagementMessage.style.color = '#ef4444';
                return;
            }

            adminManagementMessage.textContent = "Buscando usuario...";
            adminManagementMessage.style.color = '#00CED1'; // Cian

            try {
                // Buscar el perfil del usuario por su email en la colección user_profiles
                const q = query(collection(db, `user_profiles`), where('email', '==', emailToAdd), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    adminManagementMessage.textContent = `Error: No se encontró un usuario con el email ${emailToAdd}. Asegúrate de que el usuario haya iniciado sesión al menos una vez.`;
                    adminManagementMessage.style.color = '#ef4444';
                    return;
                }

                const userProfile = querySnapshot.docs[0].data();
                const newAdminUid = userProfile.uid;
                const newAdminDisplayName = userProfile.displayName || userProfile.email;

                // Añadir el documento en la colección 'admin_users' con el UID como ID
                await setDoc(doc(db, `admin_users`, newAdminUid), {
                    email: emailToAdd,
                    displayName: newAdminDisplayName,
                    addedBy: currentUser.uid,
                    addedAt: serverTimestamp()
                });

                adminManagementMessage.textContent = `¡${newAdminDisplayName} (${emailToAdd}) ha sido añadido como administrador!`;
                adminManagementMessage.style.color = '#00CED1'; // Cian
                newAdminEmailInput.value = ''; // Limpiar input

            } catch (error) {
                console.error("Error al añadir administrador:", error);
                adminManagementMessage.textContent = `Error al añadir administrador: ${error.message}`;
                adminManagementMessage.style.color = '#ef4444';
            }
        }


        // --- Manejo del Estado de Autenticación ---

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                userDisplay.textContent = user.displayName || user.email || 'Usuario';
                userDisplay.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                hideAuthError(); // Ocultar errores previos

                // Guardar/Actualizar perfil de usuario en Firestore
                await saveUserProfile(user);

                // Si el usuario se registró con email/contraseña y no ha verificado su email
                if (user.providerData[0] && user.providerData[0].providerId === 'password' && !user.emailVerified) {
                    appContainer.classList.add('hidden'); // Ocultar el contenido principal de la app
                    authModal.classList.remove('hidden'); // Mostrar el modal de autenticación
                    showEmailVerificationMessage(); // Mostrar el mensaje de verificación
                    return; // Detener el procesamiento posterior hasta que se verifique el email
                }

                // Si el email está verificado o el usuario inició sesión con otro proveedor (Google/Discord están pre-verificados)
                authModal.classList.add('hidden'); // Ocultar el modal de autenticación
                appContainer.classList.remove('hidden'); // Mostrar el contenido principal de la app
                hideEmailVerificationMessage(); // Asegurarse de que el mensaje de verificación esté oculto

                // Verificar si el usuario es administrador consultando la colección 'admin_users'
                try {
                    const adminDocRef = doc(db, `admin_users`, user.uid);
                    const adminSnapshot = await getDoc(adminDocRef); // Usar getDoc para un documento específico
                    isAdmin = adminSnapshot.exists(); // Verificar si el documento existe
                } catch (e) {
                    console.error("Error al verificar rol de administrador:", e);
                    isAdmin = false;
                }

                // Verificar si el usuario es el CEO
                isCEO = (user.uid === CEO_UID); // Compara el UID del usuario actual con el CEO_UID configurado

                // Lógica para el CEO: Asegurar que su documento de admin exista
                if (isCEO) {
                    try {
                        await setDoc(doc(db, `admin_users`, user.uid), {
                            email: user.email,
                            displayName: user.displayName || user.email,
                            addedAt: serverTimestamp(),
                            isCEO: true // Marca explícitamente como CEO
                        }, { merge: true });
                        console.log("Documento de CEO admin asegurado.");
                    } catch (e) {
                        console.error("Error al asegurar documento de CEO admin:", e);
                        // Mostrar un mensaje si falla, pero no bloquear la app
                        showCustomModal("Advertencia: No se pudo asegurar tu rol de CEO en Firestore. Revisa las reglas de seguridad.", "alert");
                    }
                }


                if (isAdmin) {
                    userChatSection.classList.add('hidden');
                    adminPanelSection.classList.remove('hidden');
                    loadAdminChatList();

                    // Mostrar la sección de administración de administradores solo si es el CEO
                    if (isCEO) {
                        adminManagementSection.classList.remove('hidden');
                    } else {
                        adminManagementSection.classList.add('hidden');
                    }

                } else {
                    // Lógica para usuarios normales (no administradores)
                    adminPanelSection.classList.add('hidden');
                    // Buscar chat existente para el usuario
                    const q = query(
                        collection(db, `artifacts/${__app_id}/public/data/chats`),
                        where('userId', '==', user.uid),
                        where('status', '==', 'open'),
                        limit(1)
                    );
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        // Si ya hay un chat abierto, cargarlo directamente
                        currentChatId = querySnapshot.docs[0].id;
                        const chatData = querySnapshot.docs[0].data();
                        currentSupportTypeDisplay.textContent = chatData.supportType || '';
                        loadUserChatMessages(currentChatId);
                        userChatSection.classList.remove('hidden'); // Mostrar la sección de chat
                        supportTypeSelectionModal.classList.add('hidden'); // Asegurarse de que el modal esté oculto
                    } else {
                        // Si no hay chat abierto, mostrar el modal de selección de tipo de soporte
                        userChatSection.classList.add('hidden'); // Ocultar la sección de chat por ahora
                        supportTypeSelectionModal.classList.remove('hidden'); // Mostrar el modal
                    }
                }
            } else {
                currentUser = null;
                isAdmin = false;
                isCEO = false; // Resetear flag de CEO
                userDisplay.classList.add('hidden');
                logoutButton.classList.add('hidden');
                appContainer.classList.add('hidden');
                authModal.classList.remove('hidden');
                // Asegurarse de que los formularios de autenticación sean visibles al cerrar sesión
                hideEmailVerificationMessage(); // Ocultar el mensaje de verificación
                authForms.classList.remove('hidden'); // Mostrar los formularios de login/registro
                loginForm.classList.remove('hidden'); // Mostrar el formulario de login por defecto
                registerForm.classList.add('hidden'); // Ocultar el formulario de registro
                adminManagementSection.classList.add('hidden'); // Ocultar sección de admin management
                supportTypeSelectionModal.classList.add('hidden'); // Ocultar el modal de selección de soporte
                if (unsubscribeMessages) {
                    unsubscribeMessages();
                    unsubscribeMessages = null;
                }
                currentChatId = null;
            }
        });

        // --- Event Listeners ---

        // Modal de autenticación
        closeAuthModalButton.addEventListener('click', () => {
            // Permitir cerrar el modal si el usuario está logeado (incluso si el email no está verificado)
            if (currentUser) {
                authModal.classList.add('hidden');
                hideAuthError();
                hideEmailVerificationMessage(); // Asegurarse de que el mensaje de verificación se oculte al cerrar el modal
            }
            // Si no hay usuario, el modal permanece abierto
        });

        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            hideAuthError();
            hideEmailVerificationMessage(); // Asegurarse de que el mensaje de verificación esté oculto
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            hideAuthError();
            hideEmailVerificationMessage(); // Asegurarse de que el mensaje de verificación esté oculto
        });

        loginButton.addEventListener('click', handleEmailLogin);
        registerButton.addEventListener('click', handleEmailRegister);
        googleAuthButton.addEventListener('click', handleGoogleAuth);
        discordAuthButton.addEventListener('click', handleDiscordAuth);
        logoutButton.addEventListener('click', handleLogout);

        // Nuevo event listener para reenviar el correo de verificación
        resendVerificationEmailButton.addEventListener('click', async () => {
            if (auth.currentUser) {
                try {
                    await sendEmailVerification(auth.currentUser);
                    showAuthError('¡Correo de verificación reenviado! Revisa tu bandeja de entrada.');
                } catch (error) {
                    console.error("Error al reenviar correo de verificación:", error);
                    showAuthError('Error al reenviar correo: ' + error.message);
                }
            }
        });


        // Chat de usuario
        // El botón "Iniciar Nuevo Chat" ahora solo es un marcador de posición,
        // la creación del chat se maneja después de la selección del tipo de soporte.
        // newChatButton.addEventListener('click', createNewChat); // Deshabilitado/Modificado
        sendUserMessageButton.addEventListener('click', () => {
            sendMessage(userMessageInput.value, 'user');
            userMessageInput.value = '';
        });
        userMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(userMessageInput.value, 'user');
                userMessageInput.value = '';
            }
        });

        // Panel de administrador
        closeChatButton.addEventListener('click', closeSelectedChat);
        sendAdminMessageButton.addEventListener('click', () => {
            sendMessage(adminMessageInput.value, 'admin');
            adminMessageInput.value = '';
        });
        adminMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(adminMessageInput.value, 'admin');
                adminMessageInput.value = '';
            }
        });

        // Event listener para añadir administrador
        addAdminButton.addEventListener('click', addAdmin);

        // Event listeners para los botones de selección de tipo de soporte
        supportTypeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const selectedType = button.dataset.type;
                hideSupportTypeError();
                createNewChat(selectedType); // Llamar a createNewChat con el tipo seleccionado
            });
        });


        // Asegurarse de que __app_id esté disponible en el entorno de Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Eliminar las llamadas a signInWithCustomToken y signInAnonymously aquí.
        // La autenticación se manejará mediante el flujo normal de la aplicación.
        // La lógica de onAuthStateChanged se encargará de mostrar el modal si no hay usuario.

        // Función para manejar modales personalizados en lugar de alert/confirm
        function showCustomModal(message, type = 'alert', callback = null) {
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999]">
                    <div class="bg-medium-dark-bg p-8 rounded-lg shadow-xl border border-border max-w-sm w-full text-center">
                        <p class="text-text-light text-lg mb-6">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="modal-ok-button" class="bg-primary text-text-dark px-6 py-2 rounded-md font-semibold hover:bg-secondary transition-colors duration-300">
                                ${type === 'alert' ? 'OK' : 'Confirmar'}
                            </button>
                            ${type === 'confirm' ? `<button id="modal-cancel-button" class="bg-red-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-red-700 transition-colors duration-300">Cancelar</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('custom-alert-modal');
            const okButton = document.getElementById('modal-ok-button');
            const cancelButton = document.getElementById('modal-cancel-button');

            okButton.onclick = () => {
                modal.remove();
                if (callback) callback(true);
            };
            if (cancelButton) {
                cancelButton.onclick = () => {
                    modal.remove();
                    if (callback) callback(false);
                };
            }
        }

        // Reemplazar alert y confirm con el modal personalizado
        window.alert = (message) => showCustomModal(message, 'alert');
        window.confirm = (message) => new Promise(resolve => showCustomModal(message, 'confirm', resolve));

    </script>
</body>
</html>
